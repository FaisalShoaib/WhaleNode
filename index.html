<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Whales üêã AI | Pro Logic Engine</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root { --bg-dark: #09090b; --bg-panel: #121214; --border: #27272a; --accent-green: #10b981; --accent-red: #ef4444; --text-main: #e4e4e7; --text-dim: #71717a; }
        body { background-color: var(--bg-dark); color: var(--text-main); font-family: 'Inter', sans-serif; font-size: 12px; min-height: 100vh; overflow-y: auto; display: flex; flex-direction: column; }
        .mono { font-family: 'JetBrains Mono', monospace; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: var(--bg-dark); }
        ::-webkit-scrollbar-thumb { background: #3f3f46; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #52525b; }
        .panel { background: var(--bg-panel); border: 1px solid var(--border); border-radius: 6px; display: flex; flex-direction: column; overflow: hidden; }
        .panel-header { background: #18181b; padding: 10px 16px; border-bottom: 1px solid var(--border); font-weight: 600; display: flex; justify-content: space-between; align-items: center; font-size: 11px; text-transform: uppercase; color: var(--text-dim); letter-spacing: 0.5px; }
        table { width: 100%; border-collapse: collapse; }
        th { text-align: left; padding: 10px 16px; background: #18181b; color: var(--text-dim); font-weight: 600; position: sticky; top: 0; z-index: 10; font-size: 10px; }
        td { padding: 8px 16px; border-bottom: 1px solid #27272a; font-family: 'JetBrains Mono', monospace; font-size: 11px; }
        tr:hover { background: #27272a; }
        .input-dark { background: #09090b; border: 1px solid var(--border); color: white; padding: 6px 10px; border-radius: 4px; font-family: 'JetBrains Mono', monospace; outline: none; transition: 0.2s; }
        .input-dark:focus { border-color: #3b82f6; }
        #desk-grid { display: flex; flex-direction: column; gap: 16px; padding: 16px; flex: 1; width: 100%; max-width: 1600px; margin: 0 auto; }
        @media (min-width: 1024px) { #desk-grid { display: grid; grid-template-columns: 1fr 350px; grid-template-rows: auto 1fr auto; align-items: start; } .area-stats { grid-column: 1 / -1; grid-row: 1 / 2; } .area-main { grid-column: 1 / 2; grid-row: 2 / 3; } .area-side { grid-column: 2 / -1; grid-row: 2 / 3; } .area-bottom { grid-column: 1 / -1; grid-row: 3 / 4; } }
        .stats-flex { display: flex; flex-direction: row; gap: 8px; width: 100%; overflow-x: auto; padding-bottom: 4px; }
        .stats-flex > .panel { flex: 1; min-width: 140px; }
        
        @keyframes premiumFlashGreen { 0% { background-color: rgba(16, 185, 129, 0.3); } 100% { background-color: transparent; } }
        @keyframes premiumFlashBlue { 0% { background-color: rgba(59, 130, 246, 0.3); } 100% { background-color: transparent; } }
        @keyframes premiumFlashRed { 0% { background-color: rgba(239, 68, 68, 0.15); } 100% { background-color: transparent; } }
        @keyframes premiumFlashPurple { 0% { background-color: rgba(168, 85, 247, 0.3); } 100% { background-color: transparent; } }
        .box-blink-green { animation: premiumFlashGreen 0.8s ease-out; } 
        .box-blink-blue { animation: premiumFlashBlue 0.8s ease-out; }
        .box-blink-red { animation: premiumFlashRed 1s ease-out; }
        .box-blink-purple { animation: premiumFlashPurple 0.8s ease-out; }
        .blink-rapid { animation: blink 0.5s infinite; }
        .text-glow-green { text-shadow: 0 0 5px rgba(74, 222, 128, 0.5); }
        .text-glow-orange { text-shadow: 0 0 5px rgba(251, 146, 60, 0.5); }
        @keyframes blink { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
        @keyframes newsGlow { 0%, 100% { color: #9ca3af; } 50% { color: #e879f9; text-shadow: 0 0 8px rgba(232, 121, 249, 0.3); } }
        .animate-news { animation: newsGlow 3s infinite ease-in-out; }
        
        #trade-flash { 
            position: fixed; inset: 0; z-index: 9998; display: none; align-items: center; justify-content: center; 
            background: rgba(0,0,0,0.4); pointer-events: none; 
        }
        #flash-box {
            background: rgba(9, 9, 11, 0.98); border: 3px solid; padding: 40px; border-radius: 16px; 
            text-align: center; min-width: 350px; box-shadow: 0 0 80px rgba(0,0,0,1);
            transform: scale(0.9); animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
        }
        @keyframes popIn { to { transform: scale(1); } }
        
        .flash-long { border-color: #10b981 !important; color: #10b981 !important; box-shadow: 0 0 50px rgba(16, 185, 129, 0.3) !important; }
        .flash-short { border-color: #ef4444 !important; color: #ef4444 !important; box-shadow: 0 0 50px rgba(239, 68, 68, 0.3) !important; }
        .flash-reverse { border-color: #a855f7 !important; color: #a855f7 !important; box-shadow: 0 0 50px rgba(168, 85, 247, 0.4) !important; }
        .flash-dca { border-color: #3b82f6 !important; color: #3b82f6 !important; box-shadow: 0 0 50px rgba(59, 130, 246, 0.4) !important; }

        #startup-modal { 
            position: fixed; inset: 0; background: #09090b; z-index: 9999; display: flex; align-items: center; justify-content: center; 
        }
        .mode-btn { flex: 1; padding: 10px; border: 1px solid #3f3f46; border-radius: 6px; cursor: pointer; transition: 0.2s; font-weight: 600; color: #71717a; background: #18181b; }
        .mode-btn.active { border-color: #10b981; color: #10b981; background: rgba(16, 185, 129, 0.1); }
        .form-group { margin-bottom: 16px; text-align: left; }
        .form-label { display: block; color: #a1a1aa; margin-bottom: 6px; font-size: 11px; font-weight: 600; }
        
        /* DCA Bar Styles */
        .dca-bar-bg { background: #374151; height: 6px; width: 100%; border-radius: 3px; overflow: hidden; margin-top: 4px; }
        .dca-fill { height: 100%; transition: width 0.3s ease; }
        .dca-pulse { animation: dcaGlow 1.5s infinite; }
        @keyframes dcaGlow { 0% { opacity: 0.6; } 50% { opacity: 1; box-shadow: 0 0 10px #3b82f6; } 100% { opacity: 0.6; } }

    </style>
</head>
<body>

    <div id="startup-modal">
        <div class="bg-[#121214] border border-[#27272a] p-8 rounded-xl max-w-md w-full shadow-2xl relative overflow-hidden">
            <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-purple-500 to-blue-500"></div>
            <div class="text-center mb-6">
                <div class="text-5xl mb-3">üß†</div>
                <h2 class="text-xl font-bold text-white tracking-wide">STRATEGY ENGINE PRO</h2>
                <p class="text-gray-500 text-xs mt-1">DCA + Smart Reversal Analysis</p>
            </div>
            <div class="flex gap-4 mb-6">
                <button id="btn-sim" class="mode-btn active" onclick="setMode('sim')"><i class="fa-solid fa-robot mb-1 block text-lg"></i> AI-Analyst Bot</button>
            </div>
            <div id="inputs-sim" class="space-y-4">
                <div class="form-group"><label class="form-label">PAPER CAPITAL ($)</label><input type="number" id="input-capital" class="input-dark w-full" value="10000" placeholder="e.g. 1000"></div>
                <div class="p-3 bg-purple-900/20 border border-purple-900/50 rounded text-purple-400 text-[10px] flex gap-2 items-start"><i class="fa-solid fa-microchip mt-0.5"></i><div><b>Pro Logic:</b> Bot uses <b>1x Leverage (Spot Mode)</b>. It divides equity into 40 slots but stops at 20 to reserve DCA capital.</div></div>
            </div>
            <button onclick="initializeBot()" class="w-full bg-purple-600 hover:bg-purple-500 text-white font-bold py-3.5 rounded-lg transition shadow-lg shadow-purple-900/20 mt-6 flex items-center justify-center gap-2"><i class="fa-solid fa-power-off"></i> ACTIVATE PRO ENGINE</button>
        </div>
    </div>

    <div id="trade-flash">
        <div id="flash-box">
            <div class="text-4xl font-bold mb-2">SMART SIGNAL</div>
            <div id="flash-msg" class="text-6xl font-mono font-bold tracking-tighter"></div>
            <div id="flash-reason" class="text-xl text-gray-300 mt-2 font-mono"></div>
        </div>
    </div>
    
    <nav class="h-12 bg-[#121214] border-b border-[#27272a] flex items-center justify-between px-6 shrink-0">
        <div class="flex items-center gap-3"><span class="text-xl">üêã</span><span class="font-bold text-white tracking-wide hidden md:block">WHALES PRO <span class="bg-blue-500/20 text-blue-400 text-[10px] px-1.5 py-0.5 rounded ml-1 border border-blue-500/30">LOGIC v2</span></span><span class="font-bold text-white tracking-wide md:hidden">WP <span class="text-orange-400 text-[10px]">AI</span></span></div>
        <div class="flex items-center gap-4 px-3 py-1 bg-[#09090b] rounded-lg border border-[#27272a] mx-2"><div class="flex items-center gap-2"><img src="https://lcw.nyc3.cdn.digitaloceanspaces.com/production/currencies/32/btc.png" onerror="this.onerror=null;this.src='https://placehold.co/16x16/09090b/e4e4e7?text=B'" class="w-4 h-4"><span class="text-gray-400 text-xs font-bold hidden sm:inline">BTC</span><span id="nav-btc" class="text-white font-mono text-xs">---</span></div><div class="w-px h-3 bg-[#27272a]"></div><div class="flex items-center gap-2"><img src="https://lcw.nyc3.cdn.digitaloceanspaces.com/production/currencies/32/eth.png" onerror="this.onerror=null;this.src='https://placehold.co/16x16/09090b/e4e4e7?text=E'" class="w-4 h-4"><span class="text-gray-400 text-xs font-bold hidden sm:inline">ETH</span><span id="nav-eth" class="text-white font-mono text-xs">---</span></div></div>
        <div class="hidden md:flex items-center gap-4 px-4 py-1 bg-[#09090b] rounded-lg border border-[#27272a] text-[10px] font-mono flex-1 mx-4"><div class="flex items-center gap-2 whitespace-nowrap"><span class="text-orange-400 font-bold">FEEDS</span><span id="global-btcd" class="text-white">0/50</span></div><div class="w-px h-3 bg-[#27272a]"></div><div class="flex items-center gap-2 whitespace-nowrap"><span class="text-blue-400 font-bold">STRATEGY</span><span id="global-mode" class="text-white font-bold">STANDBY</span></div><div class="w-px h-3 bg-[#27272a]"></div><div class="flex items-center gap-2 flex-1 min-w-0"><span class="text-purple-400 font-bold whitespace-nowrap">LOG</span><span id="global-news" class="text-gray-400 truncate w-full animate-news">Initializing...</span></div></div>
        <div class="flex flex-col items-end text-[10px] text-gray-500 font-mono"><div class="flex items-center gap-4"><span id="ping-dot" class="w-1.5 h-1.5 rounded-full bg-gray-500"></span> <span>LATENCY: <span class="text-green-400" id="ping-val">--ms</span></span></div><div id="live-clock" class="text-gray-400 mt-0.5 tracking-wide">--/--/---- --:--:--</div></div>
    </nav>

    <div id="desk-grid">
        <div class="area-stats stats-flex">
            <div class="panel p-4 justify-between bg-gradient-to-br from-[#121214] to-[#0a0a0c]"><span class="text-[10px] text-gray-500 font-bold uppercase truncate">Total Equity</span><div id="equity-display" class="text-xl font-bold text-white mono tracking-tight truncate">---</div><div class="text-xs text-gray-400 truncate">Available: <span id="available-balance" class="text-white">---</span></div></div>
            <div class="panel p-4 justify-between"><span class="text-[10px] text-gray-500 font-bold uppercase truncate">Unrealized PnL</span><div id="pnl-display" class="text-xl font-bold text-gray-500 mono truncate">$0.00</div><div class="text-[10px] text-gray-600 uppercase font-bold truncate">Floating</div></div>
            <div class="panel p-4 justify-between bg-[#18181b]"><span class="text-[10px] text-gray-500 font-bold uppercase truncate">Net Realized PnL</span><div id="net-profit-val" class="text-xl font-bold text-white mono truncate">$0.00</div><div class="flex justify-between items-center"><div class="text-[10px] text-gray-600 uppercase font-bold truncate">Win / Loss</div><div id="net-profit-wl" class="text-[10px] text-gray-400 font-mono font-bold">0 / 0</div></div></div>
            
            <div class="panel p-4 justify-between"><span class="text-[10px] text-gray-500 font-bold uppercase truncate">Total Fees</span><div id="total-fees-val" class="text-xl font-bold text-orange-400 mono truncate">$0.00</div><div class="text-[10px] text-gray-600 uppercase font-bold truncate">Paid</div></div>
            <div class="panel p-4 justify-between"><span class="text-[10px] text-gray-500 font-bold uppercase truncate">Gross Profit</span><div id="gross-profit-val" class="text-xl font-bold text-green-400 mono truncate">$0.00</div><div class="text-[10px] text-gray-600 uppercase font-bold truncate">Winners</div></div>
            <div class="panel p-4 justify-between"><span class="text-[10px] text-gray-500 font-bold uppercase truncate">Gross Loss</span><div id="gross-loss-val" class="text-xl font-bold text-red-400 mono truncate">$0.00</div><div class="text-[10px] text-gray-600 uppercase font-bold truncate">Losers</div></div>
            
            <div class="panel p-4 justify-between"><span class="text-[10px] text-gray-500 font-bold uppercase truncate">Active DCAs</span><div id="dca-active-val" class="text-xl font-bold text-blue-400 mono truncate">0</div><div class="text-[10px] text-gray-500 truncate">Scaling In</div></div>
            <div class="panel p-4 justify-between"><span class="text-[10px] text-gray-500 font-bold uppercase truncate">Reversals</span><div id="reversal-count-val" class="text-xl font-bold text-orange-400 mono truncate">0</div><div class="text-[10px] text-gray-500 truncate">Trend Shifts</div></div>
            <div class="panel p-4 justify-between"><div class="flex justify-between items-start mb-1"><span class="text-[10px] text-gray-500 font-bold uppercase truncate">Win Rate</span><div class="flex gap-3"><div class="flex flex-col items-center"><span class="text-[9px] text-gray-600 font-bold">W</span><span class="text-green-400 font-bold" id="wins">0</span></div><div class="flex flex-col items-center"><span class="text-[9px] text-gray-600 font-bold">L</span><span class="text-red-400 font-bold" id="losses">0</span></div></div></div><div class="flex items-center"><div class="flex flex-col"><span class="text-[9px] text-gray-600">Win Rate</span><div id="win-rate" class="text-xl font-bold text-white mono">0%</div></div></div></div>
            <div class="panel p-2 relative min-w-[100px]"><canvas id="miniEquityChart"></canvas></div>
        </div>

        <div class="area-main flex flex-col gap-4">
            <div class="panel flex-none">
                <div class="panel-header border-l-2 border-purple-500">
                    <div class="flex items-center gap-2"><i class="fa-solid fa-layer-group text-purple-500"></i><span>Smart Positions</span><span id="pos-count" class="bg-[#27272a] text-white px-1.5 rounded text-[10px]">0 / 20</span></div>
                    <button onclick="closeAllPositions()" class="bg-red-900/30 hover:bg-red-900/50 text-red-400 border border-red-900 px-3 py-1 rounded text-[9px] font-bold transition">PANIC CLOSE</button>
                </div>
                <div class="overflow-auto bg-[#09090b] min-h-[150px] max-h-[300px]">
                    <table class="w-full">
                        <thead>
                            <tr>
                                <th class="pl-6">Symbol</th><th>Side</th><th class="text-right">Avg Entry</th><th class="text-right">Price</th>
                                <th class="text-right text-blue-400 font-bold">DCA Lvl</th>
                                <th class="text-right text-orange-400">Lev/Size</th>
                                <th class="text-right">PnL (ROE)</th><th class="text-center pr-4">Action</th>
                            </tr>
                        </thead>
                        <tbody id="positions-body"><tr><td colspan="8" class="text-center py-12 text-gray-600 italic">Smart Engine scanning market structure...</td></tr></tbody>
                    </table>
                </div>
            </div>
            <div class="panel flex-none min-h-[200px]">
                <div class="panel-header border-l-2 border-gray-600">
                    <div class="flex items-center gap-2"><i class="fa-solid fa-clock-rotate-left text-gray-400"></i><span>Analysis & Trade History</span></div>
                    <button onclick="exportCSV()" class="text-[9px] hover:text-white transition">EXPORT CSV</button>
                </div>
                <div class="overflow-auto bg-[#09090b] max-h-[200px]">
                    <table class="w-full"><thead><tr><th class="pl-6">Time</th><th>Sym</th><th>Side</th><th>Type</th><th>Logic</th><th>Dur</th><th class="text-right">Size</th><th class="text-right">Entry</th><th class="text-right">Exit</th><th class="text-right text-gray-500">Gross</th><th class="text-right text-orange-400">Fee</th><th class="text-right">Net PnL</th><th class="text-right pr-6">% PnL</th></tr></thead><tbody id="history-body"><tr class="text-center"><td colspan="13" class="py-4 text-gray-600 italic">No history available.</td></tr></tbody></table>
                </div>
            </div>
             <div class="panel flex-1 min-h-[350px]">
                <div class="panel-header border-l-2 border-cyan-500">
                    <div class="flex items-center gap-2"><i class="fa-solid fa-code-branch text-cyan-500"></i><span>Deep Scanner</span></div>
                    <div class="text-[9px] text-gray-500 font-mono" id="scan-progress">Scanning: <span class="text-white">ACTIVE</span></div>
                </div>
                <div id="logic-table-container" class="flex-1 overflow-y-auto bg-[#09090b] p-2">
                    <table class="w-full text-left border-collapse">
                        <thead class="text-[9px] text-gray-500 border-b border-[#27272a] bg-[#121214] sticky top-0"><tr><th class="py-2 pl-4">Coin</th><th>Rec. Leverage</th><th>Structure</th><th class="pr-4 text-right">RSI</th></tr></thead>
                        <tbody id="deep-logic-body" class="text-[10px] font-mono">
                            </tbody>
                    </table>
                </div>
            </div>
            
            <div class="panel flex-1 min-h-[200px]">
                <div class="panel-header border-l-2 border-blue-500">
                    <div class="flex items-center gap-2"><i class="fa-solid fa-microchip text-blue-500"></i><span>AI Logic State</span></div>
                </div>
                <div class="flex flex-col md:flex-row h-full">
                    <div class="flex-1 p-4 border-r border-[#27272a] space-y-4">
                        <div class="text-[10px] text-gray-500 font-bold uppercase tracking-wider mb-2">Market Regime</div>
                        <div class="grid grid-cols-2 gap-4">
                            <div class="bg-[#09090b] p-3 rounded"><div class="text-[9px] text-gray-500">Global Trend</div><div id="btc-trend-display" class="text-lg font-mono text-white">NEUTRAL</div></div>
                            <div class="bg-[09090b] p-3 rounded"><div class="text-[9px] text-gray-500">DCA Strategy</div><div id="dca-strat-display" class="text-lg font-mono text-blue-400">Variance</div></div>
                            <div class="bg-[#09090b] p-3 rounded"><div class="text-[9px] text-gray-500">Stop Loss</div><div id="sl-display" class="text-lg font-mono text-gray-400">DISABLED</div></div>
                            <div class="bg-[#09090b] p-3 rounded"><div class="text-[9px] text-gray-500">Reversal</div><div id="cl-display" class="text-lg font-mono text-orange-400">Smart</div></div>
                        </div>
                    </div>
                    <div class="flex-[2] flex flex-col p-4">
                        <div class="text-[10px] text-gray-500 font-bold uppercase tracking-wider mb-2 flex justify-between"><span>Decision Logs</span><span class="text-purple-400 text-[9px]"><i class="fa-solid fa-rotate mr-1"></i> Live</span></div>
                        <div class="flex-1 overflow-y-auto bg-[#09090b] rounded p-2 border border-[#27272a]">
                            <table class="w-full text-left">
                                <thead class="text-[9px] text-gray-500 border-b border-[#27272a]"><tr><th class="pb-2 pl-2">Time</th><th>Analysis</th><th>Decision</th></tr></thead>
                                <tbody id="learning-body" class="text-[10px] font-mono"><tr><td colspan="3" class="text-center py-4 text-gray-600 italic">No adaptive events yet.</td></tr></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="panel h-auto shrink-0">
                <div class="panel-header border-l-2 border-green-500 justify-between">
                    <div class="flex items-center"><i class="fa-solid fa-brain mr-2 text-green-500"></i><span>Smart Controller</span></div>
                    <button id="bot-toggle-button" onclick="toggleBot()" class="bg-gray-700 text-gray-400 px-3 py-1 rounded text-[10px] font-bold cursor-not-allowed">RUNNING</button>
                </div>
                <div class="p-4 space-y-3">
                    <div class="flex justify-between items-center text-xs"><span class="text-gray-400">System State</span><span id="engine-mode-disp" class="text-white font-bold">---</span></div>
                    <div class="flex justify-between items-center text-xs"><span class="text-gray-400">Logic</span><span class="text-green-400 font-bold">DCA + Reversal</span></div>
                    <div class="mt-2 pt-2 border-t border-[#27272a] overflow-y-auto max-h-[200px]">
                        <div class="flex justify-between items-center text-xs mb-1"><span class="text-gray-400">Started</span><span id="start-time-display" class="text-white font-mono text-[10px]">--:--:--</span></div>
                        <div class="flex justify-between items-center text-xs mb-2"><span class="text-gray-400">Running</span><span id="runtime-display" class="text-blue-400 font-mono font-bold">00:00:00</span></div>
                        <div id="logic-status" class="text-[10px] text-gray-400 font-mono leading-tight">> Logic: <span class="text-green-500">1x SPOT MODE</span><br>> Positions: <span class="text-orange-500">Max 20</span> (Capital Reserve for DCA)</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="area-side flex flex-col gap-4">
            <div class="panel flex-none min-h-[300px]">
                <div class="panel-header border-l-2 border-orange-500"><div class="flex items-center gap-2"><i class="fa-solid fa-crosshairs text-orange-500"></i><span>Market Heatmap</span></div></div>
                <div class="p-4 h-full flex flex-col gap-4">
                    <div class="flex-1 relative min-h-[200px]"><canvas id="strategyRadarChart"></canvas></div>
                    <div class="flex-1 space-y-3 overflow-y-auto text-[10px] font-mono text-gray-400">
                        <div class="flex justify-between items-center bg-[#09090b] p-2 rounded border border-[#27272a]"><span class="text-white font-bold">Scanner:</span><span id="scanner-coin" class="text-orange-400 font-bold">Analyzing...</span></div>
                        <div class="flex justify-between items-center bg-[#09090b] p-2 rounded border border-[#27272a]"><span>Tick Update:</span><span id="scanner-timer" class="text-white">Live</span></div>
                        <div class="font-bold text-white uppercase mt-2 border-b border-gray-700 pb-1">BTC Trend Impact</div>
                        <div id="btc-impact-msg" class="p-2 rounded bg-[#09090b] text-gray-500 italic">Neutral Market</div>
                    </div>
                </div>
            </div>
            <div class="panel flex-1 min-h-[200px]"><div class="panel-header"><span>Strategy Logs</span></div><div id="sys-log" class="overflow-y-auto flex-1 p-2 font-mono text-[9px] space-y-1 text-gray-500 bg-[#09090b]"></div></div>
            <div class="panel h-auto shrink-0 min-h-[250px]"><div class="panel-header border-l-2 border-blue-500"><div class="flex items-center gap-2"><i class="fa-solid fa-water text-blue-500"></i><span>Large Orders</span></div><span class="text-[9px] text-gray-500 animate-pulse">Live (> $100k)</span></div><div class="flex-1 overflow-y-auto bg-[#09090b] p-2"><table class="w-full text-left"><thead class="text-[9px] text-gray-500 border-b border-[#27272a]"><tr><th class="pb-2 pl-2">Time</th><th>Coin</th><th>Type</th><th class="text-right pr-2">Value</th></tr></thead><tbody id="whale-tracker-body" class="text-[10px] font-mono"></tbody></table></div></div>
        </div>
        
        <div class="area-bottom grid grid-cols-1 md:grid-cols-3 gap-4">
             <div class="panel min-h-[200px]">
                <div class="panel-header border-l-2 border-yellow-500">
                    <div class="flex items-center gap-2"><i class="fa-solid fa-bolt text-yellow-500"></i><span>Latency & Execution</span></div>
                </div>
                <div class="p-4 space-y-4">
                     <div class="flex justify-between text-[10px] text-gray-400"><span>API Latency</span><span id="latency-val" class="text-green-400 font-mono">--ms</span></div>
                     <div class="w-full bg-[#27272a] rounded-full h-1.5"><div id="latency-bar" class="bg-green-500 h-1.5 rounded-full transition-all duration-300" style="width: 10%"></div></div>
                     <div class="flex justify-between text-[10px] text-gray-400"><span>Execution Quality</span><span class="text-blue-400 font-mono">REAL-TIME FEED</span></div>
                </div>
            </div>

            <div class="panel min-h-[200px]">
                 <div class="panel-header border-l-2 border-indigo-500">
                    <div class="flex items-center gap-2"><i class="fa-solid fa-scale-balanced text-indigo-500"></i><span>Exchange Arbitrage</span></div>
                </div>
                <div class="p-2 overflow-y-auto">
                    <table class="w-full text-[10px]">
                        <thead><tr class="text-gray-500 border-b border-[#27272a]"><th class="pb-1">Pair</th><th class="pb-1">Binance</th><th class="pb-1">Coinbase</th><th class="pb-1 text-right">Delta</th></tr></thead>
                        <tbody id="arb-body" class="font-mono">
                            </tbody>
                    </table>
                </div>
            </div>

            <div class="panel min-h-[200px]">
                 <div class="panel-header border-l-2 border-red-600">
                    <div class="flex items-center gap-2"><i class="fa-solid fa-chart-line text-red-600"></i><span>Market Sentiment</span></div>
                </div>
                <div class="p-4 space-y-4">
                    <div class="flex items-center justify-between p-2 bg-[#27272a]/50 rounded border border-[#3f3f46]">
                         <div class="flex flex-col"><span class="text-[10px] text-gray-400 uppercase font-bold">Open Interest</span><span class="text-xs text-white font-bold">$12.4B (+1.2%)</span></div>
                         <div class="flex flex-col text-right"><span class="text-[10px] text-gray-400 uppercase font-bold">Top Trader Ratio</span><span class="text-xs text-green-400 font-bold">Long 62%</span></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

<script>
    // --- 1. UTILITY FUNCTIONS ---
    const fmt = { 
        usd: (n) => {
            if (n === undefined || n === null || isNaN(n)) return '$0.00';
            return '$' + Number(n).toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2});
        },
        price: (n) => n < 1 ? Number(n).toFixed(5) : Number(n).toFixed(2),
        time: (t) => new Date(t).toLocaleTimeString(),
        vol: (n) => '$' + (n/1000000).toFixed(1) + 'M',
        duration: (ms) => {
            const sec = Math.floor(ms / 1000);
            const min = Math.floor(sec / 60);
            const hrs = Math.floor(min / 60);
            if (hrs > 0) return `${hrs}h ${min % 60}m`;
            if (min > 0) return `${min}m ${sec % 60}s`;
            return `${sec}s`;
        }
    };

    function safeSetText(id, text) { 
        const el = document.getElementById(id); 
        if(el) el.innerText = text; 
    }

    function log(msg, type='gray') { 
        const d = document.createElement('div'); 
        d.className = `border-l-2 pl-2 ${type==='green'?'border-green-500 text-green-400':type==='red'?'border-red-500 text-red-400':type==='purple'?'border-purple-500 text-purple-400':type==='blue'?'border-blue-500 text-blue-400':type==='orange'?'border-orange-500 text-orange-400':'border-gray-700 text-gray-400'}`; 
        d.innerHTML = `<span class="text-gray-600 font-bold">[${new Date().toLocaleTimeString().split(' ')[0]}]</span> ${msg}`; 
        const logContainer = document.getElementById('sys-log'); 
        if (logContainer) { 
            logContainer.prepend(d); 
            while (logContainer.children.length > 30) logContainer.removeChild(logContainer.lastChild); 
        } 
    }
    
    function updateTopBar(id, price, change) { 
        const el = document.getElementById(`nav-${id}`); 
        if(!el) return;
        const p = parseFloat(price); 
        const c = parseFloat(change); 
        const color = c >= 0 ? 'text-green-400' : 'text-red-400'; 
        el.innerHTML = `${fmt.price(p)} <span class="${color} text-[10px]">(${c.toFixed(2)}%)</span>`; 
    }

    function logAdaptiveEvent(analysis, decision) {
        const tbody = document.getElementById('learning-body');
        const row = `
            <tr class="border-b border-[#27272a] bg-[#18181b] animate-pulse">
                <td class="pl-2 py-2 text-gray-500">${new Date().toLocaleTimeString()}</td>
                <td class="text-white font-bold text-[9px]">${analysis}</td>
                <td class="text-purple-400 font-bold text-[9px]">${decision}</td>
            </tr>
        `;
        tbody.insertAdjacentHTML('afterbegin', row);
        if(tbody.children.length > 20) tbody.removeChild(tbody.lastChild);
    }

    // --- APP STATE ---
    let WATCHLIST = []; 
    let VALID_FUTURES_SYMBOLS = new Set(); 
    let whaleBuffer = []; 
    
    // EXPLICIT BLACKLIST
    const BLACKLIST = ['xmrusdt', 'antusdt', 'btcdomusdt', 'defiusdt', 'bluebirdusdt'];
    const CURATED_SAFE_LIST = ['btcusdt', 'ethusdt', 'solusdt', 'bnbusdt', 'xrpusdt', 'adausdt', 'dogeusdt', 'avaxusdt', 'linkusdt', 'maticusdt'];

    const MAX_POSITIONS = 40; 
    const ACTIVE_TRADE_LIMIT = 20; // Stop taking new positions after 20 to reserve DCA capital
    const FEE_RATE = 0.0005; // 0.05% per side -> 0.1% Round Trip
    let activeStreamCount = 0;
    
    const app = { 
        coins: {}, 
        history: {}, 
        bot: { 
            balance: 10000, 
            equity: 10000, 
            active: false, 
            startTime: null, 
            positions: {}, 
            tradeHistory: [],
            wins: 0,
            losses: 0,
            reversals: 0,
            activeDCAs: 0,
            feesPaid: 0,
            cooldowns: {} 
        }
    };

    // --- RSI CALCULATOR ---
    function calculateRSI(closes) {
        if (closes.length < 14) return 50; 
        let gains = 0, losses = 0;
        for (let i = 1; i <= 14; i++) {
            const diff = closes[i] - closes[i - 1];
            if (diff >= 0) gains += diff;
            else losses += Math.abs(diff);
        }
        let avgGain = gains / 14;
        let avgLoss = losses / 14;
        for (let i = 15; i < closes.length; i++) {
            const diff = closes[i] - closes[i - 1];
            if (diff >= 0) {
                avgGain = (avgGain * 13 + diff) / 14;
                avgLoss = (avgLoss * 13 + 0) / 14;
            } else {
                avgGain = (avgGain * 13 + 0) / 14;
                avgLoss = (avgLoss * 13 + Math.abs(diff)) / 14;
            }
        }
        if (avgLoss === 0) return 100;
        const rs = avgGain / avgLoss;
        return 100 - (100 / (1 + rs));
    }

    // --- DYNAMIC LEVERAGE & VOLATILITY ---
    function getDynamicLeverage(symbol, history) {
        return 1; // Strict 1x Leverage per user request
    }

    // --- INITIALIZATION ---
    function setMode(mode) {
        document.getElementById('btn-sim').className = `mode-btn active`;
    }

    async function initializeBot() {
        const capital = parseFloat(document.getElementById('input-capital').value) || 10000;
        app.bot.balance = capital;
        app.bot.equity = capital;
        app.bot.startTime = new Date();
        app.bot.active = true;

        document.getElementById('startup-modal').style.display = 'none';
        safeSetText('start-time-display', `${app.bot.startTime.toLocaleDateString()} ${app.bot.startTime.toLocaleTimeString()}`);
        safeSetText('equity-display', fmt.usd(app.bot.balance));
        safeSetText('available-balance', fmt.usd(app.bot.balance));
        safeSetText('global-mode', 'DCA-AI');
        safeSetText('engine-mode-disp', 'PRO-LOGIC');
        document.getElementById('global-mode').className = `text-purple-400 font-bold`;

        log(`PRO ENGINE ONLINE. Initializing Market Structure Analysis...`, 'purple');
        
        await fetchTopCoins();
        initCharts();
        startWebSocket();
    }

    async function fetchTopCoins() {
        try {
            log("Verifying Binance Futures Exchange Info...", "blue");
            const exchangeInfoRes = await fetch('https://fapi.binance.com/fapi/v1/exchangeInfo');
            const exchangeInfo = await exchangeInfoRes.json();
            
            VALID_FUTURES_SYMBOLS = new Set(
                exchangeInfo.symbols
                    .filter(s => s.status === 'TRADING' && s.contractType === 'PERPETUAL' && s.quoteAsset === 'USDT')
                    .map(s => s.symbol)
            );

            log(`Found ${VALID_FUTURES_SYMBOLS.size} active USDT-M pairs.`, "blue");

            const res = await fetch('https://fapi.binance.com/fapi/v1/ticker/24hr');
            const data = await res.json();
            
            const top50 = data
                .filter(t => VALID_FUTURES_SYMBOLS.has(t.symbol) && !BLACKLIST.includes(t.symbol.toLowerCase()))
                .sort((a,b) => parseFloat(b.quoteVolume) - parseFloat(a.quoteVolume))
                .slice(0, 50)
                .map(t => t.symbol.toLowerCase());
            
            WATCHLIST = top50;
            log(`Loaded Top ${WATCHLIST.length} Strictly Valid Futures Pairs.`, 'green');

        } catch(e) {
            log("API Blocked/Failed. Engaging Safe Curated List.", "red");
            WATCHLIST = CURATED_SAFE_LIST;
            CURATED_SAFE_LIST.forEach(s => VALID_FUTURES_SYMBOLS.add(s.toUpperCase()));
        }

        const batchSize = 10;
        for(let i=0; i<WATCHLIST.length; i+=batchSize) {
            const batch = WATCHLIST.slice(i, i+batchSize);
            await Promise.all(batch.map(async (sym) => {
                try {
                    const kRes = await fetch(`https://fapi.binance.com/fapi/v1/klines?symbol=${sym.toUpperCase()}&interval=1m&limit=30`);
                    const kData = await kRes.json();
                    app.history[sym] = kData.map(d => parseFloat(d[4]));
                } catch(e) {}
            }));
            safeSetText('scan-progress', `Loading History: ${Math.min(100, Math.round((i/WATCHLIST.length)*100))}%`);
        }
        safeSetText('scan-progress', 'SCANNING ACTIVE');
    }

    // --- WEBSOCKET ENGINE ---
    function startWebSocket() {
        // UI Feedback: Connecting
        safeSetText('global-news', "Connecting to Feed...");
        const pingDot = document.getElementById('ping-dot');
        if(pingDot) pingDot.className = "w-1.5 h-1.5 rounded-full bg-yellow-500 animate-pulse";

        const ws = new WebSocket(`wss://fstream.binance.com/stream?streams=!ticker@arr`);

        ws.onopen = () => {
            log("WebSocket Connected. Stream Active.", "green");
            safeSetText('global-news', "Socket Open - Live Data");
            if(pingDot) pingDot.className = "w-1.5 h-1.5 rounded-full bg-green-500 animate-pulse";
            
            const streams = [];
            WATCHLIST.forEach(s => { streams.push(`${s}@aggTrade`); streams.push(`${s}@kline_1m`); });

            for (let i = 0; i < streams.length; i += 50) {
                const chunk = streams.slice(i, i + 50);
                ws.send(JSON.stringify({ method: "SUBSCRIBE", params: chunk, id: i + 2 }));
            }
        };

        ws.onmessage = (event) => {
            let msg = JSON.parse(event.data);
            if (msg.stream && msg.data) { msg = msg.data; }
            if (msg.result === null && msg.id) return; 

            // 1. Ticker Handling
            if (Array.isArray(msg) && msg[0] && msg[0].e === '24hrTicker') {
                msg.forEach(t => {
                    const s = t.s.toLowerCase();
                    if (WATCHLIST.includes(s)) {
                        if (!app.coins[s]) app.coins[s] = {};
                        app.coins[s].change = parseFloat(t.P);
                        app.coins[s].vol = parseFloat(t.q); 
                        if (!app.coins[s].price) app.coins[s].price = parseFloat(t.c); 
                        if(s === 'btcusdt') updateTopBar('btc', t.c, t.P);
                        if(s === 'ethusdt') updateTopBar('eth', t.c, t.P);
                    }
                });
                return;
            }

            // 2. Kline Handling
            if (msg.e === 'kline') {
                const s = msg.s.toLowerCase();
                const k = msg.k;
                
                if (!app.history[s]) app.history[s] = [];
                if (k.x) { 
                    app.history[s].push(parseFloat(k.c));
                    if(app.history[s].length > 50) app.history[s].shift();
                }
                const currentHistory = [...app.history[s], parseFloat(k.c)];
                const rsi = calculateRSI(currentHistory);
                
                if (!app.coins[s]) app.coins[s] = { price: parseFloat(k.c), change: 0, vol: 0 };
                app.coins[s].rsi = rsi;

                if(!app.coins[s].active) {
                    app.coins[s].active = true;
                    activeStreamCount++;
                    safeSetText('global-btcd', `${activeStreamCount}/50`);
                }

                // --- SMART AUTO TRADING LOGIC ---
                checkSignal(s, rsi, parseFloat(k.c));
            }

            // 3. Whale Handling
            if (msg.e === 'aggTrade') {
                const s = msg.s.toLowerCase();
                const price = parseFloat(msg.p);
                
                if (app.coins[s]) app.coins[s].price = price;
                else app.coins[s] = { price: price, change: 0, vol: 0 };
                
                // CRITICAL: Check Reversal Logic on every Tick
                if(app.bot.positions[s]) updatePositionPnL(s, price);

                const val = price * parseFloat(msg.q);
                if (val > 100000) { 
                    const side = msg.m ? 'SELL' : 'BUY';
                    whaleBuffer.push({
                        time: msg.T,
                        symbol: s.toUpperCase().replace('USDT',''),
                        side: side,
                        val: val
                    });
                    if(val > 500000 && Object.keys(app.bot.positions).length < MAX_POSITIONS) {
                        showFlash(side, s.toUpperCase().replace('USDT',''), `WHALE ${fmt.usd(val)}`);
                    }
                }
            }
        };

        ws.onclose = () => {
            log("WebSocket Connection Lost. Reconnecting in 3s...", "red");
            safeSetText('global-news', "Reconnecting...");
            if(pingDot) pingDot.className = "w-1.5 h-1.5 rounded-full bg-red-500";
            setTimeout(startWebSocket, 3000);
        };

        ws.onerror = (err) => {
            console.error("WebSocket Error:", err);
            ws.close();
        };
    }

    // --- SMART TRADING ENGINE ---
    
    function checkSignal(symbol, rsi, price) {
        if (!price || price <= 0 || isNaN(price)) return; 
        if (app.bot.positions[symbol]) return; 

        const lastClosed = app.bot.cooldowns[symbol] || 0;
        if (Date.now() - lastClosed < 60000) return; // 1 min cooldown

        const activeCount = Object.keys(app.bot.positions).length;
        if (activeCount >= ACTIVE_TRADE_LIMIT) return; // Stop taking new positions after 20

        // --- 1. DETERMINE GLOBAL BTC SENTIMENT ---
        const btcChange = app.coins['btcusdt']?.change || 0;
        let btcRegime = 'NEUTRAL';
        if (btcChange < -2.0) btcRegime = 'BEARISH';
        if (btcChange > 2.0) btcRegime = 'BULLISH';
        
        let buyThresh = 30;
        let sellThresh = 70;

        // Filter: Don't fight extreme trends initially
        if (btcRegime === 'BEARISH') buyThresh = 20; 
        if (btcRegime === 'BULLISH') sellThresh = 80;

        // --- 2. EXECUTION ---
        // Calc Leverage based on volatility
        const leverage = 1; // Strict 1x

        // Position Sizing: Equal divide by 40
        const initialMargin = app.bot.equity / MAX_POSITIONS; 
        
        const sizeUSD = initialMargin * leverage;
        const coinSize = sizeUSD / price;

        if (rsi < buyThresh) {
            executeTrade(symbol, 'LONG', price, coinSize, initialMargin, leverage, 'OVERSOLD');
        } else if (rsi > sellThresh) {
            executeTrade(symbol, 'SHORT', price, coinSize, initialMargin, leverage, 'OVERBOUGHT');
        }
        
        safeSetText('btc-trend-display', btcRegime);
    }

    function executeTrade(symbol, side, price, size, marginUsed, leverage, reason) {
        if (!price || price <= 0 || isNaN(price)) return;
        if (!VALID_FUTURES_SYMBOLS.has(symbol.toUpperCase())) return;

        // Fee Calculation
        const notional = size * price;
        const fee = notional * FEE_RATE;
        app.bot.balance -= fee; 
        app.bot.feesPaid += fee; // Track Fees
        
        // Create Position Object
        app.bot.positions[symbol] = {
            symbol: symbol,
            side: side,
            avgEntry: price,
            totalSize: size,       // Coin amount
            totalMargin: marginUsed, // USDT Margin used
            leverage: leverage,
            pnl: 0,
            accumulatedFees: fee, // Track accumulated fees (Entry + DCAs)
            startTime: Date.now(),
            highestPrice: price,
            lowestPrice: price,
            trailingActive: false,
            lastStopPrice: 0,
            dcaCount: 0,           // How many DCAs done
            entries: [{price: price, size: size, time: Date.now()}] // Log of entries
        };
        
        log(`‚ö° OPEN (${reason}): ${side} ${symbol.toUpperCase()} ${leverage}x | $${notional.toFixed(0)}`, side === 'LONG' ? 'green' : 'red');
        showFlash(side, symbol.toUpperCase().replace('USDT',''), `LEV ${leverage}x`);
        updateDashboardPositions();
    }

    // --- ANALYTIC ENGINE (DCA vs REVERSAL) ---
    function updatePositionPnL(symbol, currentPrice) {
        const pos = app.bot.positions[symbol];
        if (!pos) return;

        // 1. Calculate PnL
        const notional = pos.totalSize * currentPrice;
        let pnl = 0;
        if (pos.side === 'LONG') pnl = (currentPrice - pos.avgEntry) * pos.totalSize;
        else pnl = (pos.avgEntry - currentPrice) * pos.totalSize;

        pos.pnl = pnl;
        const roe = (pnl / pos.totalMargin) * 100;
        
        // --- 2. ADVERSE EXCURSION ANALYSIS ---
        // Calculate price deviation percentage (negative if losing)
        const priceDevPct = (pos.side === 'LONG') 
            ? (currentPrice - pos.avgEntry) / pos.avgEntry 
            : (pos.avgEntry - currentPrice) / pos.avgEntry;

        // TRIGGER ANALYSIS if Deviation < -1.5% (approx) and not in cooldown
        // We use -0.015 as a trigger point for "Action Required"
        if (priceDevPct < -0.015) {
             decideRecoveryStrategy(symbol, pos, currentPrice, priceDevPct);
        }

        // --- 3. TRAILING TAKE PROFIT LOGIC ---
        // Only active if profitable
        if (roe > 0) {
            const TRAILING_ACTIVATION = 1.5; // Activate at 1.5% profit
            const TRAILING_DISTANCE = 0.003; // 0.3% price distance

            if (pos.side === 'LONG') {
                if (currentPrice > pos.highestPrice) pos.highestPrice = currentPrice;
                if (!pos.trailingActive && roe >= TRAILING_ACTIVATION) pos.trailingActive = true;
                if (pos.trailingActive) {
                    const stopPrice = pos.highestPrice * (1 - TRAILING_DISTANCE);
                    pos.lastStopPrice = stopPrice;
                    if (currentPrice < stopPrice) closePosition(symbol, currentPrice, "TRAILING_PROFIT");
                }
            } else {
                if (currentPrice < pos.lowestPrice) pos.lowestPrice = currentPrice;
                if (!pos.trailingActive && roe >= TRAILING_ACTIVATION) pos.trailingActive = true;
                if (pos.trailingActive) {
                    const stopPrice = pos.lowestPrice * (1 + TRAILING_DISTANCE);
                    pos.lastStopPrice = stopPrice;
                    if (currentPrice > stopPrice) closePosition(symbol, currentPrice, "TRAILING_PROFIT");
                }
            }
        }
    }

    function decideRecoveryStrategy(symbol, pos, currentPrice, devPct) {
        // Prevent action spamming
        if (pos.lastActionTime && Date.now() - pos.lastActionTime < 10000) return;

        // --- ANALYZE MARKET CONTEXT ---
        const rsi = app.coins[symbol]?.rsi || 50;
        const btcTrend = app.coins['btcusdt']?.change || 0;
        
        // LOGIC A: REVERSAL
        // If we are LONG, but BTC is dumping hard (< -1.5%) AND RSI is not oversold (room to fall further)
        // Then the trend has likely shifted against us. Reverse.
        if (pos.side === 'LONG' && btcTrend < -1.5 && rsi > 35) {
             performReversal(symbol, pos, currentPrice, "TREND_SHIFT_BEAR");
             return;
        }
        if (pos.side === 'SHORT' && btcTrend > 1.5 && rsi < 65) {
             performReversal(symbol, pos, currentPrice, "TREND_SHIFT_BULL");
             return;
        }

        // LOGIC B: DCA (HOLD & ADD)
        // If deviation matches our steps (-1.5%, -3.0%, -6.0%)
        // AND we haven't maxed out DCAs (3 max)
        // AND Indicators suggest it's just a wick (e.g. RSI extreme or BTC neutral)
        
        // Define DCA thresholds with variance
        const step1 = -0.015; // -1.5%
        const step2 = -0.030; // -3.0%
        const step3 = -0.060; // -6.0%

        let shouldDCA = false;

        if (pos.dcaCount === 0 && devPct < step1) shouldDCA = true;
        else if (pos.dcaCount === 1 && devPct < step2) shouldDCA = true;
        else if (pos.dcaCount === 2 && devPct < step3) shouldDCA = true;

        if (shouldDCA) {
            if (pos.dcaCount < 3) {
                performDCA(symbol, pos, currentPrice);
            } else {
                // Max DCA reached. We HOLD.
                // User said "No stop loss", so we wait for reversal condition or profit.
                // However, we can update the status to "HOLDING_BAG"
                if (!pos.holdingBag) {
                    log(`‚ö†Ô∏è MAX DCA REACHED on ${symbol}. Holding for recovery...`, "orange");
                    pos.holdingBag = true;
                }
            }
        }
    }

    function performReversal(symbol, pos, currentPrice, reason) {
        logAdaptiveEvent(`Structure Break (${reason})`, "REVERSAL TRIGGERED");
        
        // 1. Close current
        closePosition(symbol, currentPrice, "STOP_REVERSE");
        
        // 2. Open Opposite immediately
        delete app.bot.cooldowns[symbol]; // Clear cooldown
        const newSide = pos.side === 'LONG' ? 'SHORT' : 'LONG';
        
        // Recalculate safe size
        const initialMargin = app.bot.equity / MAX_POSITIONS; 
        const leverage = 1;
        const sizeUSD = initialMargin * leverage;
        const coinSize = sizeUSD / currentPrice;

        executeTrade(symbol, newSide, currentPrice, coinSize, initialMargin, leverage, "AUTO_REVERSAL");
        app.bot.reversals++;
        safeSetText('reversal-count-val', app.bot.reversals);
    }

    function performDCA(symbol, pos, currentPrice) {
        pos.dcaCount++;
        pos.lastActionTime = Date.now();
        
        // Add same amount of margin as initial entry (Linear Scaling)
        // Or we could double down (Martingale), but user asked for "lower position size initially" implying scaling.
        // Let's add 1 unit.
        // Initial was 0.25 margin unit. We add another 0.25 margin unit.
        
        const addMargin = app.bot.equity / MAX_POSITIONS; // Constant add size
        const addSizeUSD = addMargin * pos.leverage;
        const addCoinSize = addSizeUSD / currentPrice;
        
        // Safety Check: Do we have enough available balance?
        // We use accumulated Margin to track 'used' funds.
        const totalUsed = Object.values(app.bot.positions).reduce((acc, p) => acc + p.totalMargin, 0);
        const available = app.bot.balance - totalUsed;
        
        if (available < addMargin) {
            log(`‚ö†Ô∏è DCA REJECTED on ${symbol}: Insufficient Capital (Reserved Limit Hit)`, "red");
            // Revert count
            pos.dcaCount--;
            return;
        }

        // Fee
        const dcaFee = addSizeUSD * FEE_RATE;
        app.bot.balance -= dcaFee;
        app.bot.feesPaid += dcaFee; // Track DCA Fee
        pos.accumulatedFees += dcaFee; // Track per position

        // Update Position Averages
        const totalCoinsOld = pos.totalSize;
        const totalCostOld = pos.avgEntry * pos.totalSize;
        const addCost = currentPrice * addCoinSize;
        
        const newTotalCoins = totalCoinsOld + addCoinSize;
        const newAvgEntry = (totalCostOld + addCost) / newTotalCoins;

        pos.totalSize = newTotalCoins;
        pos.avgEntry = newAvgEntry;
        pos.totalMargin += addMargin;
        pos.entries.push({price: currentPrice, size: addCoinSize, time: Date.now()});

        log(`üõ°Ô∏è DCA #${pos.dcaCount} ${symbol}: Added ${fmt.usd(addSizeUSD)} @ ${fmt.price(currentPrice)}. New Avg: ${fmt.price(newAvgEntry)}`, "blue");
        showFlash("DCA", symbol.toUpperCase().replace('USDT',''), `LEVEL ${pos.dcaCount}`);
        logAdaptiveEvent("Price Deviation", `DCA BUY ${pos.dcaCount}/3`);
        
        updateDashboardPositions();
    }

    function closePosition(symbol, price, reason) {
        const pos = app.bot.positions[symbol];
        if (!pos) return;

        const notionalExit = pos.totalSize * price;
        const exitFee = notionalExit * FEE_RATE;
        
        app.bot.balance += pos.pnl; // Add PnL to balance
        app.bot.balance -= exitFee; // Deduct Exit Fee
        app.bot.feesPaid += exitFee; // Track Exit Fee
        
        // Net PnL = Gross PnL - (EntryFees + DCA Fees + ExitFees)
        const totalTradeFees = pos.accumulatedFees + exitFee;
        const netPnl = pos.pnl - totalTradeFees;

        if (netPnl > 0) app.bot.wins++;
        else app.bot.losses++;

        app.bot.cooldowns[symbol] = Date.now();
        
        // Calculate duration
        const duration = Date.now() - pos.startTime;

        const record = {
            time: Date.now(),
            symbol: symbol.toUpperCase(),
            side: pos.side,
            type: pos.dcaCount > 0 ? `DCA (${pos.dcaCount})` : 'Std',
            logic: reason,
            size: pos.totalSize * price,
            entry: pos.avgEntry,
            exit: price,
            fee: totalTradeFees,
            netPnl: netPnl,
            duration: duration
        };
        app.bot.tradeHistory.unshift(record);
        if(app.bot.tradeHistory.length > 200) app.bot.tradeHistory.pop();
        
        delete app.bot.positions[symbol];
        log(`üí∞ CLOSED ${symbol.toUpperCase()}: ${reason} | Net: ${fmt.usd(netPnl)}`, netPnl > 0 ? 'green' : 'red');
        
        updateHistoryUI();
        updateDashboardPositions();
    }

    // --- UI UPDATERS ---

    function updateDashboardPositions() {
        const tbody = document.getElementById('positions-body');
        const positions = Object.values(app.bot.positions);
        
        // Count active DCAs
        let totalDcas = 0;
        let totalMarginUsed = 0; // Track locked margin
        positions.forEach(p => {
            totalDcas += p.dcaCount;
            totalMarginUsed += p.totalMargin;
        });
        
        safeSetText('dca-active-val', totalDcas);
        
        // Enhanced UI: Show limit
        const posCountEl = document.getElementById('pos-count');
        if (posCountEl) posCountEl.innerText = `${positions.length} / ${ACTIVE_TRADE_LIMIT}`;

        if (positions.length === 0) {
            tbody.innerHTML = `<tr><td colspan="10" class="text-center py-12 text-gray-600 italic">Smart Engine scanning... Waiting for setup.</td></tr>`;
            
            // Even if empty, update balance display
            app.bot.equity = app.bot.balance;
            safeSetText('equity-display', fmt.usd(app.bot.equity));
            safeSetText('available-balance', fmt.usd(app.bot.balance));
            return;
        }
        
        let html = '';
        let totalUnrealized = 0;

        positions.forEach(p => {
            totalUnrealized += p.pnl;
            const pnlClass = p.pnl >= 0 ? 'text-green-400' : 'text-red-400';
            const roe = ((p.pnl / p.totalMargin) * 100).toFixed(2);
            
            const curr = app.coins[p.symbol]?.price || p.avgEntry;
            
            let actionDisplay = `<span class="text-blue-400 text-[9px] font-bold">MONITORING</span>`;
            if (p.trailingActive) actionDisplay = `<span class="text-green-400 text-[9px] font-bold animate-pulse">TRAILING</span>`;
            
            // Visual DCA Bar Logic
            const dcaPct = (p.dcaCount / 3) * 100;
            const dcaColor = p.dcaCount === 3 ? 'bg-red-500 dca-pulse' : 'bg-blue-500';
            const dcaBar = `
                <div class="flex items-center gap-2 justify-end">
                    <span class="text-blue-400 text-[10px] font-mono font-bold">${p.dcaCount} / 3</span>
                </div>
                <div class="dca-bar-bg">
                    <div class="dca-fill ${dcaColor}" style="width: ${dcaPct}%"></div>
                </div>
            `;

            html += `
                <tr class="hover:bg-[#18181b] transition border-b border-[#27272a]/50">
                    <td class="pl-6 font-bold text-white py-3 flex items-center gap-3">
                        <img src="https://assets.coincap.io/assets/icons/${p.symbol.replace('usdt','').replace('1000','')}@2x.png" onerror="this.onerror=null;this.src='https://placehold.co/32x32/27272a/e4e4e7?text=${p.symbol.substring(0,1).toUpperCase()}'" class="w-8 h-8 rounded-full bg-[#27272a] p-0.5">
                        <div class="flex flex-col"><span class="text-[13px] uppercase font-bold">${p.symbol.replace('usdt','').toUpperCase()}</span><span class="text-[10px] text-gray-500">PERP</span></div>
                    </td>
                    <td class="font-bold ${p.side==='LONG'?'text-green-400':'text-red-400'}">${p.side}</td>
                    <td class="text-right font-mono text-gray-400 text-[11px]">${fmt.price(p.avgEntry)}</td>
                    <td class="text-right font-mono text-white text-[12px] font-bold">${fmt.price(curr)}</td>
                    <td class="text-right font-mono text-[11px]">${dcaBar}</td>
                    <td class="text-right font-mono text-orange-400 text-[11px]">${p.leverage}x (${fmt.usd(p.totalSize * curr)})</td>
                    <td class="text-right font-mono font-bold ${pnlClass}">
                        <div>${fmt.usd(p.pnl)}</div>
                        <div class="text-[10px] opacity-75">${roe}%</div>
                    </td>
                    <td class="text-center pr-4 text-[10px] font-mono leading-tight">
                        ${actionDisplay}
                        <div class="mt-1"><button onclick="closePosition('${p.symbol}', ${curr}, 'MANUAL')" class="bg-red-900/40 hover:bg-red-900/60 text-red-300 px-2 py-0.5 rounded transition text-[9px]">CLOSE</button></div>
                    </td>
                </tr>
            `;
        });
        
        tbody.innerHTML = html;
        app.bot.equity = app.bot.balance + totalUnrealized;
        safeSetText('equity-display', fmt.usd(app.bot.equity));
        
        // Update Available Balance (Cash - Margin Used)
        const available = app.bot.balance - totalMarginUsed;
        safeSetText('available-balance', fmt.usd(available));
        
        safeSetText('pnl-display', fmt.usd(totalUnrealized));
        
        const pnlEl = document.getElementById('pnl-display');
        pnlEl.className = `text-xl font-bold mono truncate ${totalUnrealized >= 0 ? 'text-green-400' : 'text-red-400'}`;
    }

    function updateHistoryUI() {
        let calcNetRealized = 0;
        let grossProfit = 0;
        let grossLoss = 0;

        app.bot.tradeHistory.forEach(t => {
            calcNetRealized += t.netPnl;
            // Gross PnL is Net PnL + Total Fees
            const gross = t.netPnl + t.fee; 
            if(gross > 0) grossProfit += gross;
            else grossLoss += gross;
        });

        const tbody = document.getElementById('history-body');
        const rows = app.bot.tradeHistory.slice(0, 50); 
        
        if (rows.length === 0) {
            tbody.innerHTML = '<tr class="text-center"><td colspan="13" class="py-4 text-gray-600 italic">No history available.</td></tr>';
        } else {
            tbody.innerHTML = rows.map(t => {
                // Determine Percentage PnL
                const sideMult = t.side === 'LONG' ? 1 : -1;
                const rawPct = ((t.exit - t.entry) / t.entry) * 100 * sideMult;
                
                // Gross PnL
                const gross = t.netPnl + t.fee;
                const grossColor = gross >= 0 ? 'text-green-400' : 'text-red-400';

                return `
                <tr class="hover:bg-[#18181b] border-b border-[#27272a]">
                    <td class="pl-6 text-gray-500 text-[11px] font-mono">${fmt.time(t.time)}</td>
                    <td class="font-bold text-white text-[11px]">${t.symbol}</td>
                    <td class="font-bold ${t.side==='LONG'?'text-green-400':'text-red-400'} text-[10px]">${t.side}</td>
                    <td class="text-gray-300 font-bold text-[10px]">${t.type}</td>
                    <td class="text-[10px] text-blue-300 font-mono">${t.logic}</td>
                    <td class="text-[10px] text-gray-500 font-mono">${fmt.duration(t.duration)}</td>
                    <td class="text-right font-mono text-gray-300 text-[11px]">${fmt.usd(t.size)}</td>
                    <td class="text-right font-mono text-gray-400 text-[11px]">${fmt.price(t.entry)}</td>
                    <td class="text-right font-mono text-gray-400 text-[11px]">${fmt.price(t.exit)}</td>
                    <td class="text-right font-mono ${grossColor} text-[11px]">${fmt.usd(gross)}</td>
                    <td class="text-right font-mono text-orange-400 text-[11px]">${fmt.usd(t.fee)}</td>
                    <td class="text-right font-mono font-bold text-[11px] ${(t.netPnl>=0?'text-green-400':'text-red-400')}">${fmt.usd(t.netPnl)}</td>
                    <td class="text-right pr-6 font-mono font-bold text-[11px] ${(rawPct>=0?'text-green-400':'text-red-400')}">${rawPct.toFixed(2)}%</td>
                </tr>
            `}).join('');
        }
        
        safeSetText('wins', app.bot.wins);
        safeSetText('losses', app.bot.losses);
        
        // Update new metric boxes
        safeSetText('total-fees-val', fmt.usd(app.bot.feesPaid));
        safeSetText('gross-profit-val', fmt.usd(grossProfit));
        safeSetText('gross-loss-val', fmt.usd(grossLoss));
        
        const total = app.bot.wins + app.bot.losses;
        const wr = total > 0 ? ((app.bot.wins / total) * 100).toFixed(0) : 0;
        safeSetText('win-rate', `${wr}%`);
        
        const netEl = document.getElementById('net-profit-val');
        netEl.innerText = fmt.usd(calcNetRealized);
        netEl.className = `text-xl font-bold mono truncate ${calcNetRealized >= 0 ? 'text-green-400' : 'text-red-400'}`;
        safeSetText('net-profit-wl', `${app.bot.wins} / ${app.bot.losses}`);
        
        let totalRoi = 0;
        if (app.bot.equity > 0) totalRoi = ((calcNetRealized / app.bot.equity) * 100).toFixed(2);
        safeSetText('total-roi-box', totalRoi + '%');
    }

    function updateLogicScanner() {
        const tbody = document.getElementById('deep-logic-body');
        const sorted = [...WATCHLIST].sort((a,b) => {
            const rsiA = Math.abs((app.coins[a]?.rsi || 50) - 50);
            const rsiB = Math.abs((app.coins[b]?.rsi || 50) - 50);
            return rsiB - rsiA;
        }).slice(0, 15); 

        tbody.innerHTML = sorted.map(s => {
            const rsi = app.coins[s]?.rsi || 50;
            const lev = getDynamicLeverage(s, app.history[s]);
            let status = "NEUTRAL";
            let color = "text-gray-500";
            if (rsi < 30) { status = "OVERSOLD"; color = "text-green-400 font-bold"; }
            else if (rsi > 70) { status = "OVERBOUGHT"; color = "text-red-400 font-bold"; }
            
            return `
                <tr class="border-b border-[#27272a]">
                    <td class="py-1 pl-4 text-white uppercase">${s.replace('usdt','')}</td>
                    <td class="text-orange-400 font-bold text-[10px]">${lev}x</td>
                    <td class="${color} text-[10px]">${status}</td>
                    <td class="pr-4 text-right font-mono text-gray-300">${rsi.toFixed(1)}</td>
                </tr>
            `;
        }).join('');
    }

    // MISSING FUNCTION RESTORED HERE
    function showFlash(side, symbol, reason) { 
        const overlay = document.getElementById('trade-flash'); 
        const msg = document.getElementById('flash-msg'); 
        const sub = document.getElementById('flash-reason'); 
        
        if (side === 'LONG' || side === 'BUY') overlay.className = 'flash-long';
        else if (side === 'REVERSE') overlay.className = 'flash-reverse';
        else if (side === 'DCA') overlay.className = 'flash-dca';
        else overlay.className = 'flash-short';

        msg.innerText = `${side} ${symbol}`; 
        sub.innerText = reason || ""; 
        sub.style.display = reason ? "block" : "none"; 
        overlay.style.display = 'flex'; 
        setTimeout(() => { overlay.style.display = 'none'; }, 2000); 
    }

    // --- CHART SETUP ---
    let eqChart; let radarChart;
    function initCharts() {
        if (typeof Chart !== 'undefined') {
            const ctx1 = document.getElementById('miniEquityChart').getContext('2d');
            eqChart = new Chart(ctx1, { type: 'line', data: { labels: Array(20).fill(''), datasets: [{ data: Array(20).fill(10000), borderColor: '#10b981', backgroundColor: 'rgba(16, 185, 129, 0.1)', borderWidth: 2, pointRadius: 0, tension: 0.4, fill: true }] }, options: { responsive: true, maintainAspectRatio: false, plugins: {legend:{display:false}}, scales: {x:{display:false}, y:{display:false}} } });
            
            const ctx2 = document.getElementById('strategyRadarChart').getContext('2d');
            radarChart = new Chart(ctx2, { type: 'radar', data: { labels: ['BTC', 'ETH', 'SOL', 'BNB', 'DOGE', 'XRP'], datasets: [{ label: 'Real-Time RSI', data: [50,50,50,50,50,50], backgroundColor: 'rgba(16, 185, 129, 0.2)', borderColor: '#10b981', borderWidth: 2 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { labels: { color: '#9ca3af', font: {size: 9} } } }, scales: { r: { angleLines: { color: '#374151' }, grid: { color: '#374151' }, pointLabels: { color: '#e5e7eb', font: { size: 9 } }, ticks: { display: false }, suggestedMin: 0, suggestedMax: 100 } } } });
        }
    }

    // --- LOOPS ---
    setInterval(() => { const now = new Date(); safeSetText('live-clock', now.toLocaleString()); }, 1000);
    setInterval(() => {
        updateDashboardPositions();
        updateLogicScanner();
        if(whaleBuffer.length > 0) {
            const body = document.getElementById('whale-tracker-body');
            const htmlToAdd = whaleBuffer.slice(-20).reverse().map(item => {
                const color = item.side === 'BUY' ? 'text-green-400' : 'text-red-400';
                 return `<tr class="border-b border-[#27272a] animate-pulse bg-[#18181b]"><td class="pl-2 py-1 text-gray-500">${new Date(item.time).toLocaleTimeString()}</td><td class="font-bold text-white">${item.symbol}</td><td class="${color} font-bold">${item.side}</td><td class="text-right pr-2 text-gray-300 font-bold">${fmt.usd(item.val).split('.')[0]}</td></tr>`;
            }).join('');
            body.insertAdjacentHTML('afterbegin', htmlToAdd);
            whaleBuffer = []; 
            while(body.children.length > 50) body.removeChild(body.lastChild);
        }
        if(Math.random() > 0.8 && eqChart) {
            eqChart.data.datasets[0].data.push(app.bot.equity);
            eqChart.data.datasets[0].data.shift();
            eqChart.update('none');
        }
    }, 1000); 
    
    setInterval(() => { 
        if(app.bot.active) {
            const diff = new Date() - app.bot.startTime;
            const h = Math.floor(diff / 3600000).toString().padStart(2, '0');
            const m = Math.floor((diff % 3600000) / 60000).toString().padStart(2, '0');
            const s = Math.floor((diff % 60000) / 1000).toString().padStart(2, '0');
            safeSetText('runtime-display', `${h}:${m}:${s}`);
        }
    }, 1000);

    function closeAllPositions() { 
        Object.keys(app.bot.positions).forEach(k => {
            const p = app.bot.positions[k];
            closePosition(k, app.coins[k.toLowerCase()]?.price || p.avgEntry, "PANIC_CLOSE");
        });
    }
    function exportCSV() { alert("Exporting Real-Time Data Log..."); }
    function toggleBot() { alert("Scanner is always active in Real-Time mode."); }

</script>
</body>
</html>
